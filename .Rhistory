Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-exp(theta[3])
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat*n_fish),size=n_fish, prob=Pred_mat, log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),log(0.001),log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-exp(theta[3])
b<-exp(theta[4])
(Winf*(1-exp(-K*(age-t0))))^b
age<-0:30
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-exp(theta[3])
b<-exp(theta[4])
(Winf*(1-exp(-K*(age-t0))))^b
fit_mat_wtVB<-function(theta){
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat*n_fish),size=n_fish, prob=Pred_mat, log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),log(0.001),log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
warnings()
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
(Winf*(1-exp(-K*(age-t0))))^b
fit
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
log(0.001)
fit_mat_wtVB<-function(theta){
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat*n_fish),size=n_fish, prob=Pred_mat, log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
(Winf*(1-exp(-K*(age-t0))))^b
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
exp(fit$par[1])
exp(theta[4])
exp(fit$par[4])
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
Winf<-1
K<-exp(theta[1])
t0<-theta[2]
b<-exp(theta[3])
#  Winf<-exp(theta[1])
#  K<-exp(theta[2])
#  t0<-theta[3]
#  b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-1
K<-exp(fit$par[1])
t0<-fit$par[2]
b<-exp(fit$par[3])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
n_fish[5:31]
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
Winf<-1
K<-exp(theta[1])
t0<-theta[2]
b<-exp(theta[3])
#  Winf<-exp(theta[1])
#  K<-exp(theta[2])
#  t0<-theta[3]
#  b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
#When asymptote is fixed
Winf<-1
K<-exp(fit$par[1])
t0<-fit$par[2]
b<-exp(fit$par[3])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
exp(fit$par[1])
Winf<-1
K<-0.2
t0<-fit$par[2]
b<-exp(fit$par[3])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
b
exp(fit$par[3])
Winf<-1
K<-0.2
t0<-fit$par[2]
b<-2
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
b<-3
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
b<-1.2
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
Winf<-1
K<-0.2
t0<-fit$par[2]
b<-1.3
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=3)
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_logis<-function(theta){
k<-exp(theta[1])
x0<-exp(theta[2])
age<-0:30
Pred_mat<- 1 / (1+exp(-k*(age-x0)))
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat[10:31]*n_fish[10:31]),size=n_fish[10:31], prob=Pred_mat, log=TRUE))
return(NLL)
}
theta=c(-0.742324,2.233761)
fit_logis<-optim(par=theta, fn=fit_mat_logis)
p_mat <- 1/ (1+exp(-exp(fit_logis$par[1])*(0:30-exp(fit_logis$par[2]))))
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
lines(0:30,p_mat, col=2, lwd=2)
lines(0:30, 1/ (1+exp(-0.35*(0:30-9))), col=3, lwd=3 )
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
Winf<-1
K<-exp(theta[1])
t0<-theta[2]
b<-exp(theta[3])
#  Winf<-exp(theta[1])
#  K<-exp(theta[2])
#  t0<-theta[3]
#  b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
#When asymptote is fixed
Winf<-1
K<-exp(fit$par[1])
t0<-fit$par[2]
b<-exp(fit$par[3])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(1), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
fit<-optim(par=theta, fn=fit_mat_wtVB, lower=c(-10,-100,-10,-10), upper=c(0,1,1,10))
fit<-optim(par=theta, fn=fit_mat_wtVB, lower=c(-10,-100,-10,-10), upper=c(0,1,1,10), method="Brent")
fit<-optim(par=theta, fn=fit_mat_wtVB, lower=c(-10,-100,-10,-10), upper=c(0,1,1,10), method="BFGS")
fit<-optim(par=theta, fn=fit_mat_wtVB, lower=c(-10,-100,-10,-10), upper=c(0,1,1,10), method="L-BFGS-B")
theta<-c(log(0.999), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB, lower=c(-10,-100,-10,-10), upper=c(log(1),1,1,10), method="L-BFGS-B")
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
(Winf*(1-exp(-K*(age-t0))))^b
dbinom(x=round(mat_dat*1000),size=1000, prob=(Winf*(1-exp(-K*(age-t0))))^b, log=TRUE)
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
(Winf*(1-exp(-K*(age-t0))))^b
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
NLL<--1*sum(dbinom(x=round(mat_dat*1000),size=1000, prob=Pred_mat, log=TRUE))
return(NLL)
}
theta<-c(log(0.999), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(0.999), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=5)
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(0.999), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=4)
exp(fit$par[1])
Winf<-0.998
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=4)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=4)
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=4)
exp(fit$par[1])
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(0.999), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=4)
exp(fit$par[1])
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=2)
mat_dat<-c(0,0,0,0,0.00990099,0.048672566,0.118942731,0.242424242,0.411471322,0.494949495,0.611111111,0.72175981, 0.766315789,0.848407643,0.865963855,0.897125567,0.83853211,0.920199501,0.951351351,0.95,0.925252525,0.947075209,0.974763407,0.971428571,0.94488189,0.980842912,0.970873786,0.984455959,0.980582524,0.99,0.979487179)
n_fish<-c(0,0,22,93,101,226,227,330,401,594,720,841,950,785,664,661,545,401,370,360,rep(495,5),rep(261,5),195)
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
plot(0:30,mat_dat, las=1, pch=16, xlab="Age", ylab="Proportion Mature")
fit_mat_wtVB<-function(theta){
#  Winf<-1
#  K<-exp(theta[1])
#  t0<-theta[2]
#  b<-exp(theta[3])
Winf<-exp(theta[1])
K<-exp(theta[2])
t0<-theta[3]
b<-exp(theta[4])
age<-0:30
Pred_mat<- (Winf*(1-exp(-K*(age-t0))))^b
#  NLL<-sum((mat_dat-Pred_mat)^2)
NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*n_fish[5:31]),size=n_fish[5:31], prob=Pred_mat[5:31], log=TRUE))
#  NLL<--1*sum(dbinom(x=round(mat_dat[5:31]*1000),size=1000, prob=Pred_mat[5:31], log=TRUE))
return(NLL)
}
theta<-c(log(0.999), log(0.3),-0.001,log(3) )
fit<-optim(par=theta, fn=fit_mat_wtVB)
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
age<-0:30
Winf<-exp(fit$par[1])
K<-exp(fit$par[2])
t0<-fit$par[3]
b<-exp(fit$par[4])
(Winf*(1-exp(-K*(age-t0))))^b
lines(age,(Winf*(1-exp(-K*(age-t0))))^b, lwd=2, col=4)
fit
C:\Users\fischn\Documents\GitHub\CKMR_Project
wd<-"C:/Users/fischn/Documents/GitHub/CKMR_Project/"
devtools::install_github("kaskr/TMB_contrib_R/TMBhelper")
#########################
#Ncomp 1000, sdindex 0.5
#########################
load(paste0(wd,"/Flatfish_wdat_N1000_Ind50_ckmrmultinom25_1.RData"))
Flatfish_OM<-Flatfish_wdat
#TMB Section
library(TMB)
setwd(wd)
#Compile and load model
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
N_sim<-1:100
res_list<-list()
for (Q in 2:2){  #Running through the life history types
res_list[[Q]]<-list()
for (s in N_sim){
if(Q==1){
OM<-Cod_OM[[s]]
} else if (Q==2){
OM<-Flatfish_OM[[s]]
}else if (Q==3){
OM<-Sardine_OM[[s]]
}
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa,
#CKMR
born_year_old=OM$born_year_old-(OM$fyear_dat-1),
age_diff=OM$age_diff,
n_ckmr=OM$n_ckmr,
k_ckmr_hsp=OM$k_ckmr_hsp,
born_year_young=OM$born_year_young-(OM$fyear_dat-1),
k_ckmr_pop=OM$k_ckmr_pop,
samp_year_old=OM$samp_year_old-(OM$fyear_dat-1),
#Switch for whether to use a data source or not, 0=no, 1=yes
Lamda_Harvest=1,
Lamda_Comp=1,
Lamda_Index=1,
Lamda_CKMR=1)
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  0,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA <- MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0", map=fixed, random=reffects)
SCAA_fit <- TMBhelper::fit_tmb(obj=SCAA, startpar=SCAA$par, lower=l, upper=u, newtonsteps=1, getsd=TRUE,bias.correct=TRUE,getHessian=TRUE)
res_list[[Q]][[s]]<-SCAA_fit
print(c(Q,s))
}
}
saveRDS(res_list[[2]], file=paste0(wd,"/SCAAfit_Flatfish_N1000_Ind50_ckmrmultinom.RData"))
