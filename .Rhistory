for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N200_Ind25_ckmrmultinom10_1.RData"))
wd<-"C:/Users/nfisch/Documents/GitHub/CKMR_Project/"
N_sim<-100
Cod_wdat<-Flatfish_wdat<-Sardine_wdat<-list()
N_comp_preCKMR<-100
N_comp_CKMR<-200
sd_catch<-0.05
sd_index<-0.25
fyear_dat<-26
lyear_dat<-100
prop_ckmr<-1
fyear_ckmr<-91
lyear_ckmr<-100
progress_bar<-TRUE
for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N200_Ind25_ckmrmultinom10_1.RData"))
save(Flatfish_wdat, file=paste0(wd,"/Flatfish_wdat_N200_Ind25_ckmrmultinom10_1.RData"))
save(Sardine_wdat, file=paste0(wd,"/Sardine_wdat_N200_Ind25_ckmrmultinom10_1.RData"))
#Ncomp 200, sdindex 0.5
N_sim<-100
Cod_wdat<-Flatfish_wdat<-Sardine_wdat<-list()
N_comp_preCKMR<-100
N_comp_CKMR<-200
sd_catch<-0.05
sd_index<-0.5
fyear_dat<-26
lyear_dat<-100
prop_ckmr<-1
fyear_ckmr<-91
lyear_ckmr<-100
progress_bar<-TRUE
for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N200_Ind50_ckmrmultinom10_1.RData"))
save(Flatfish_wdat, file=paste0(wd,"/Flatfish_wdat_N200_Ind50_ckmrmultinom10_1.RData"))
save(Sardine_wdat, file=paste0(wd,"/Sardine_wdat_N200_Ind50_ckmrmultinom10_1.RData"))
#Ncomp 1000, sdindex 0.25
N_sim<-100
Cod_wdat<-Flatfish_wdat<-Sardine_wdat<-list()
N_comp_preCKMR<-100
N_comp_CKMR<-1000
sd_catch<-0.05
sd_index<-0.25
fyear_dat<-26
lyear_dat<-100
prop_ckmr<-1
fyear_ckmr<-91
lyear_ckmr<-100
progress_bar<-TRUE
for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N1000_Ind25_ckmrmultinom10_1.RData"))
save(Flatfish_wdat, file=paste0(wd,"/Flatfish_wdat_N1000_Ind25_ckmrmultinom10_1.RData"))
save(Sardine_wdat, file=paste0(wd,"/Sardine_wdat_N1000_Ind25_ckmrmultinom10_1.RData"))
#Ncomp 1000, sdindex 0.5
N_sim<-100
Cod_wdat<-Flatfish_wdat<-Sardine_wdat<-list()
N_comp_preCKMR<-100
N_comp_CKMR<-1000
sd_catch<-0.05
sd_index<-0.5
fyear_dat<-26
lyear_dat<-100
prop_ckmr<-1
fyear_ckmr<-91
lyear_ckmr<-100
progress_bar<-TRUE
for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N1000_Ind50_ckmrmultinom10_1.RData"))
save(Flatfish_wdat, file=paste0(wd,"/Flatfish_wdat_N1000_Ind50_ckmrmultinom10_1.RData"))
save(Sardine_wdat, file=paste0(wd,"/Sardine_wdat_N1000_Ind50_ckmrmultinom10_1.RData"))
#Ncomp 2000, sdindex 0.25
N_sim<-100
Cod_wdat<-Flatfish_wdat<-Sardine_wdat<-list()
N_comp_preCKMR<-100
N_comp_CKMR<-2000
sd_catch<-0.05
sd_index<-0.25
fyear_dat<-26
lyear_dat<-100
prop_ckmr<-1
fyear_ckmr<-91
lyear_ckmr<-100
progress_bar<-TRUE
for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N2000_Ind25_ckmrmultinom10_1.RData"))
save(Flatfish_wdat, file=paste0(wd,"/Flatfish_wdat_N2000_Ind25_ckmrmultinom10_1.RData"))
save(Sardine_wdat, file=paste0(wd,"/Sardine_wdat_N2000_Ind25_ckmrmultinom10_1.RData"))
#Ncomp 2000, sdindex 0.5
N_sim<-100
Cod_wdat<-Flatfish_wdat<-Sardine_wdat<-list()
N_comp_preCKMR<-100
N_comp_CKMR<-2000
sd_catch<-0.05
sd_index<-0.5
fyear_dat<-26
lyear_dat<-100
prop_ckmr<-1
fyear_ckmr<-91
lyear_ckmr<-100
progress_bar<-TRUE
for (s in 1:N_sim){
Cod_wdat[[s]]     <-Get_Data(OM=Cod_runs[[s]],     dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Flatfish_wdat[[s]]<-Get_Data(OM=Flatfish_runs[[s]],dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
Sardine_wdat[[s]] <-Get_Data(OM=Sardine_runs[[s]], dat_seed=s,fyear_dat=fyear_dat,lyear_dat=lyear_dat,sd_catch=sd_catch,N_Comp_preCKMR=N_comp_preCKMR,N_Comp_CKMR=N_comp_CKMR,q_index=0.0001,sd_index=sd_index,prop_ckmr=prop_ckmr,fyear_ckmr=fyear_ckmr,lyear_ckmr=lyear_ckmr)
if(progress_bar==TRUE){
plot(rep(1,length(1:s)), pch=16)
}
}
save(Cod_wdat, file=paste0(wd,"/Cod_wdat_N2000_Ind50_ckmrmultinom10_1.RData"))
save(Flatfish_wdat, file=paste0(wd,"/Flatfish_wdat_N2000_Ind50_ckmrmultinom10_1.RData"))
save(Sardine_wdat, file=paste0(wd,"/Sardine_wdat_N2000_Ind50_ckmrmultinom10_1.RData"))
wd<-"C:/Users/nfisch/Documents/GitHub/CKMR_Project/"
load(paste0(wd,"/Cod_wdat_N200_Ind25_ckmrmultinom25_1.RData"))
load(paste0(wd,"/Flatfish_wdat_N200_Ind25_ckmrmultinom25_1.RData"))
load(paste0(wd,"/Sardine_wdat_N200_Ind25_ckmrmultinom25_1.RData"))
Cod_OM<-Cod_wdat
Flatfish_OM<-Flatfish_wdat
Sardine_OM<-Sardine_wdat
wd<-"C:/Users/nfisch/Documents/"
library(TMB)
setwd(wd)
#Compile and load model
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
s<-1
OM<-Sardine_OM[[s]]
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa,
#CKMR
born_year_old=OM$born_year_old-(OM$fyear_dat-1),
age_diff=OM$age_diff,
n_ckmr=OM$n_ckmr,
k_ckmr_hsp=OM$k_ckmr_hsp,
born_year_young=OM$born_year_young-(OM$fyear_dat-1),
k_ckmr_pop=OM$k_ckmr_pop,
samp_year_old=OM$samp_year_old-(OM$fyear_dat-1))
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
OM$born_year_old[1]
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  5,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA <- MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0", map=fixed, random=reffects)
SCAA_fit <- TMBhelper::fit_tmb(obj=SCAA, startpar=SCAA$par, lower=l, upper=u)
compile("SCAA_Fisch_wAge0.cpp")
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa)
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
################
#TMB stuff
################
dyn.load(dynlib("SCAA_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="SCAA_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  0,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA <- MakeADFun(dat, par, DLL="SCAA_Fisch_wAge0", map=fixed, random=reffects)
SCAA$report()$L4
SCAA$report()$L4
SCAA$report()$L4
wd<-"C:/Users/nfisch/Documents/GitHub/CKMR_Project/"
library(TMB)
setwd(wd)
#Compile and load model
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
OM<-Sardine_OM[[s]]
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa,
#CKMR
born_year_old=OM$born_year_old-(OM$fyear_dat-1),
age_diff=OM$age_diff,
n_ckmr=OM$n_ckmr,
k_ckmr_hsp=OM$k_ckmr_hsp,
born_year_young=OM$born_year_young-(OM$fyear_dat-1),
k_ckmr_pop=OM$k_ckmr_pop,
samp_year_old=OM$samp_year_old-(OM$fyear_dat-1))
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  5,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA <- MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0", map=fixed, random=reffects)
SCAA_fit2 <- TMBhelper::fit_tmb(obj=SCAA, startpar=SCAA$par, lower=l, upper=u)
head(SCAA_fit$diagnostics)
head(SCAA_fit2$diagnostics)
(SCAA_fit2$diagnostics$MLE-SCAA_fit2$diagnostics$MLE)
(SCAA_fit2$diagnostics$MLE-SCAA_fit$diagnostics$MLE)
(SCAA_fit$SD$value)
(SCAA_fit2$SD$value)
length(SCAA_fit2$SD$value)
(SCAA_fit2$SD$value[170:227])
(SCAA_fit2$SD$value[165:227])
(SCAA_fit2$SD$value[160:227])
(SCAA_fit2$SD$value[155:227])
(SCAA_fit2$SD$value[145:227])
(SCAA_fit2$SD$value[152:227])
(SCAA_fit2$SD$value[151:227])
(SCAA_fit2$SD$value[152:227])
SCAA_fit2$SD$value[152:227]-SCAA_fit$SD$value
SCAA_fit$SD$value
(SCAA_fit2$SD$value[152:227])
wd
wd<-"C:/Users/nfisch/Documents/"
library(TMB)
setwd(wd)
#Compile and load model
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
s<-1
OM<-Sardine_OM[[s]]
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa,
#CKMR
born_year_old=OM$born_year_old-(OM$fyear_dat-1),
age_diff=OM$age_diff,
n_ckmr=OM$n_ckmr,
k_ckmr_hsp=OM$k_ckmr_hsp,
born_year_young=OM$born_year_young-(OM$fyear_dat-1),
k_ckmr_pop=OM$k_ckmr_pop,
samp_year_old=OM$samp_year_old-(OM$fyear_dat-1))
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  5,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA_efficient <- MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0", map=fixed, random=reffects)
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA$report()$spbiomass
wd<-"C:/Users/nfisch/Documents/GitHub/CKMR_Project/"
load(paste0(wd,"/Cod_wdat_N200_Ind25_ckmrmultinom25_1.RData"))
load(paste0(wd,"/Flatfish_wdat_N200_Ind25_ckmrmultinom25_1.RData"))
load(paste0(wd,"/Sardine_wdat_N200_Ind25_ckmrmultinom25_1.RData"))
Cod_OM<-Cod_wdat
Flatfish_OM<-Flatfish_wdat
Sardine_OM<-Sardine_wdat
library(TMB)
setwd(wd)
#Compile and load model
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
OM<-Sardine_OM[[s]]
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa,
#CKMR
born_year_old=OM$born_year_old-(OM$fyear_dat-1),
age_diff=OM$age_diff,
n_ckmr=OM$n_ckmr,
k_ckmr_hsp=OM$k_ckmr_hsp,
born_year_young=OM$born_year_young-(OM$fyear_dat-1),
k_ckmr_pop=OM$k_ckmr_pop,
samp_year_old=OM$samp_year_old-(OM$fyear_dat-1))
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  5,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA <- MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0", map=fixed, random=reffects)
SCAA$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$L4
SCAA$report()$L4
wd<-"C:/Users/nfisch/Documents/"
######################################
compile("CKMRmultinom_HSP_and_POP_Fisch_wAge0.cpp")
dat<-list(fyear=OM$OM$fyear, lyear=75, fage=OM$OM$fage, lage=OM$OM$lage,
years=OM$OM$fyear:75, ages=OM$OM$fage:OM$OM$lage,
obs_harv=OM$Obs_Catch,
obs_index=OM$Obs_Index,
obs_fishery_comp=OM$Obs_Catch_Comp/rowSums(OM$Obs_Catch_Comp),
SS_fishery=rowSums(OM$Obs_Catch_Comp),
Mat=OM$OM$Mat,
Laa=OM$OM$Laa,
Waa=OM$OM$Waa,
#CKMR
born_year_old=OM$born_year_old-(OM$fyear_dat-1),
age_diff=OM$age_diff,
n_ckmr=OM$n_ckmr,
k_ckmr_hsp=OM$k_ckmr_hsp,
born_year_young=OM$born_year_young-(OM$fyear_dat-1),
k_ckmr_pop=OM$k_ckmr_pop,
samp_year_old=OM$samp_year_old-(OM$fyear_dat-1))
#Parameters
set.seed(s)
par <- list(log_M=log(runif(1,min=OM$OM$Mref-OM$OM$Mref*0.2,max=OM$OM$Mref+OM$OM$Mref*0.2)),
log_q=log(runif(1,min=OM$q_index-OM$q_index*0.2,max=OM$q_index+OM$q_index*0.2)),
log_recruit_devs_init=rep(0,dat$lage),
log_recruit_devs=rep(0,dat$lyear),
steepness=OM$OM$h,
log_R0=log(runif(1,min=OM$OM$R0-OM$OM$R0*0.2,max=OM$OM$R0+OM$OM$R0*0.2)),
log_sigma_rec=log(OM$OM$sd_rec),
log_sd_catch=log(OM$sd_catch),
log_sd_index=log(OM$sd_index),
Sel_logis_k=log(runif(1,min=OM$OM$Sel_slope-OM$OM$Sel_slope*0.2,max=OM$OM$Sel_slope+OM$OM$Sel_slope*0.2)),
Sel_logis_midpt=log(runif(1,min=OM$OM$Sel_50-OM$OM$Sel_50*0.2,max=OM$OM$Sel_50+OM$OM$Sel_50*0.2)),
log_fint=log(runif(length(OM$OM$F_int[26:100]),min=OM$OM$F_int[26:100]-OM$OM$F_int[26:100]*0.2,max=OM$OM$F_int[26:100]+OM$OM$F_int[26:100]*0.2)))
dyn.load(dynlib("CKMRmultinom_HSP_and_POP_Fisch_wAge0"))
parm_names<-names(MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0")$par)
fixed<-list(steepness=factor(NA),
log_sd_catch=factor(NA),
log_sd_index=factor(NA))
lower_bounds<-c(-5,-20,rep(-10,dat$lage),rep(-10,dat$lyear), 0, 5, -5,-5,-5,-5,-5,rep(-10,dat$lyear))
upper_bounds<-c( 2,  1,rep( 10,dat$lage),rep( 10,dat$lyear), 1, 25, 2, 2, 2, 5, 5,rep(  5,dat$lyear))
reffects=c("log_recruit_devs","log_recruit_devs_init")
l<-lower_bounds[-which(parm_names %in% c(names(fixed),reffects))]
u<-upper_bounds[-which(parm_names %in% c(names(fixed),reffects))]
SCAA_efficient <- MakeADFun(dat, par, DLL="CKMRmultinom_HSP_and_POP_Fisch_wAge0", map=fixed, random=reffects)
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA_efficient$report()$spbiomass
SCAA$report()$spbiomass
SCAA$report()$surv_prob
SCAA$report()$surv_prob[32,]
SCAA_efficient$report()$surv_prob[32,]
SCAA_efficient$report()$surv_prob[60,]
SCAA$report()$surv_prob[60,]
SCAA_efficient$report()$surv_prob[2000,]
SCAA$report()$surv_prob[2000,]
